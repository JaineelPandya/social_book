{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - Social Book{% endblock %}

{% block extra_css %}
<style>
	.sticky-header {
		position: sticky;
		top: 0;
		z-index: 1000;
		background: #fff;
		border-bottom: 1px solid #e0e0e0;
		padding: 1rem 0;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05)
	}

	.page-wrapper {
		background-color: #f5f6fb;
		min-height: 100vh
	}

	.stat-card {
		background: linear-gradient(135deg, #4680ff 0%, #3a6dd8 100%);
		color: white;
		padding: 2.5rem;
		border-radius: 10px;
		text-align: center;
		box-shadow: 0 8px 24px rgba(70, 128, 255, 0.25);
		margin-bottom: 2rem
	}

	.stat-card.stat-card-2 {
		background: linear-gradient(135deg, #3bba9f 0%, #2fa08a 100%)
	}

	.stat-value {
		font-size: 3rem;
		font-weight: 700;
		display: block;
		margin-bottom: 0.5rem
	}

	.stat-label {
		font-size: 1rem;
		opacity: 0.95;
		letter-spacing: 0.5px
	}

	.welcome-card {
		background: #fff;
		padding: 2rem;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
		margin-bottom: 2rem
	}

	.action-card {
		background: #fff;
		padding: 1.5rem;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
		text-align: center;
		transition: transform .2s
	}

	.action-card:hover {
		transform: translateY(-5px)
	}

	.action-icon {
		font-size: 2.5rem;
		color: #4680ff;
		margin-bottom: 1rem
	}
</style>
{% endblock %}

{% block content %}
<script>
	if (!localStorage.getItem("token")) {
		window.location.href = "/";
	}
</script>

<!-- Sticky Header -->
<div class="sticky-header">
	<div class="container">
		<div class="d-flex justify-content-between align-items-center">
			<h4 style="margin:0">Dashboard</h4>
			<div class="dropdown">
				<button class="btn btn-secondary dropdown-toggle" type="button" id="userMenu" data-toggle="dropdown"
					aria-haspopup="true" aria-expanded="false">
					<i class="dw dw-user"></i> {{ user.first_name|default:user.email }}
				</button>
				<div class="dropdown-menu dropdown-menu-right" aria-labelledby="userMenu">
					<a class="dropdown-item" href="{% url 'profile' %}">Profile</a>
					<a class="dropdown-item" href="{% url 'my_books' %}">My Books</a>
					<a class="dropdown-item" href="{% url 'upload_books' %}">Upload Books</a>
					<a class="dropdown-item" href="{% url 'authors:list' %}">Browse Authors</a>
					<div class="dropdown-divider"></div>
					<button class="dropdown-item" onclick="logoutUser()">Logout</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="page-wrapper">
	<div class="container-fluid pd-20 pd-sm-40">
		<!-- Welcome Section -->
		<div class="welcome-card">
			<h2 class="mb-2">Welcome back, {{ user.get_full_name|default:user.email }}!</h2>
			<p class="text-muted mb-0">Here's an overview of the Social Book platform</p>
		</div>

		<!-- Platform Statistics -->
		<div class="row mb-30">
			<div class="col-md-6 mb-20">
				<div class="stat-card">
					<span class="stat-value">{{ total_users }}</span>
					<span class="stat-label">Total Users on Platform</span>
				</div>
			</div>
			<div class="col-md-6 mb-20">
				<div class="stat-card stat-card-2">
					<span class="stat-value">{{ total_books }}</span>
					<span class="stat-label">Total Books Uploaded</span>
				</div>
			</div>
		</div>

		<!-- Quick Actions -->
		<h3 class="mb-3">Quick Actions</h3>
		<div class="row">
			<div class="col-md-3 mb-3">
				<a href="{% url 'my_books' %}" style="text-decoration:none">
					<div class="action-card">
						<div class="action-icon">
							<i class="icon-copy dw dw-library"></i>
						</div>
						<h5>My Books</h5>
						<p class="text-muted small mb-0">View and manage your uploaded books</p>
					</div>
				</a>
			</div>
			<div class="col-md-3 mb-3">
				<a href="{% url 'upload_books' %}" style="text-decoration:none">
					<div class="action-card">
						<div class="action-icon">
							<i class="icon-copy dw dw-upload"></i>
						</div>
						<h5>Upload Books</h5>
						<p class="text-muted small mb-0">Share your books with the community</p>
					</div>
				</a>
			</div>
			<div class="col-md-3 mb-3">
				<a href="{% url 'authors:list' %}" style="text-decoration:none">
					<div class="action-card">
						<div class="action-icon">
							<i class="icon-copy dw dw-user-2"></i>
						</div>
						<h5>Browse Authors</h5>
						<p class="text-muted small mb-0">Discover authors and their books</p>
					</div>
				</a>
			</div>
			<div class="col-md-3 mb-3">
				<a href="{% url 'profile' %}" style="text-decoration:none">
					<div class="action-card">
						<div class="action-icon">
							<i class="icon-copy dw dw-user-1"></i>
						</div>
						<h5>Profile</h5>
						<p class="text-muted small mb-0">Update your profile information</p>
					</div>
				</a>
			</div>
		</div>
	</div>
</div>

<style>
	.dropdown-menu {
		border: 1px solid #d9d9d9;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		min-width: 180px
	}

	.dropdown-menu .dropdown-item {
		padding: 0.75rem 1rem;
		color: #333
	}

	.dropdown-menu .dropdown-item:hover {
		background-color: #f5f6fb;
		color: #4680ff
	}

	.dropdown-divider {
		margin: 0.5rem 0;
		border-color: #e0e0e0
	}
</style>

<script>
	async function logoutUser() {
		try {
			const token = localStorage.getItem('token');

			// Call API logout if token exists
			if (token) {
				await fetch("/api/auth/token/logout/", {
					method: "POST",
					headers: {
						"Authorization": `Token ${token}`,
						"Content-Type": "application/json"
					}
				});
			}

			// Clear localStorage token
			localStorage.removeItem('token');

			// Redirect to Django logout (clears session) then to home
			window.location.href = '/accounts/logout/';
		} catch (error) {
			console.error('Logout error:', error);
			// Even if API fails, clear token and redirect
			localStorage.removeItem('token');
			window.location.href = '/accounts/logout/';
		}
	}
</script>
{% endblock %}