{% extends 'base/base.html' %}
{% block title %}Login{% endblock %}

{% block extra_css %}
<style>
	body {
		background-color: #f5f5f5;
	}
	.login-container {
		max-width: 400px;
		margin: 80px auto;
		padding: 30px;
		background: #fff;
		border-radius: 8px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	}
	.login-container h2 {
		margin-bottom: 20px;
		font-weight: 600;		
		text-align: center;
	}
	.form-group {
		margin-bottom: 15px;
	}
	.form-control {
		width: 100%;
		height: 45px;
		font-size: 16px;
		border-radius: 6px;
		border: 1px solid #ccc;
		padding: 10px;	
		transition: border-color 0.3s;
		box-sizing: border-box;
	}
	.form-control:focus {
		border-color: #007bff;
		box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
		outline: none;
	}
	#signin-btn {
		width: 100%;
		height: 45px;
		font-size: 16px;
		border-radius: 6px;
		background-color: #007bff;		
		color: #fff;
		border: none;
		cursor: pointer;
		transition: background-color 0.3s;
		margin-top: 10px;
	}
	#signin-btn:hover {
		background-color: #0056b3;
	}
	#signin-btn:disabled {
		background-color: #cccccc;
		cursor: not-allowed;
	}
	#error-msg {
		color: #d32f2f;
		background-color: #ffebee;
		margin-bottom: 15px;	
		padding: 10px;
		border-radius: 4px;
		display: none;
		text-align: center;
	}
	.login-footer {
		text-align: center;
		margin-top: 15px;
		font-size: 14px;
	}
	.login-footer a {
		color: #007bff;
		text-decoration: none;
	}
	.login-footer a:hover {
		text-decoration: underline;
	}
</style>
{% endblock %}

{% block content %}
<div class="login-container">
	<h2>Sign In to Your Account</h2>
	
	<!-- Error message display -->
	<div id="error-msg"></div>
	
	<!-- Login form -->
	<form id="login-form" method="POST">
		{% csrf_token %}
		
		<div class="form-group">
			<label for="email">Email Address</label>
			<input 
				type="email" 
				id="email" 
				name="email" 
				class="form-control" 
				placeholder="Enter your email"
				required
			/>
		</div>

		<div class="form-group">
			<label for="password">Password</label>
			<input 
				type="password" 
				id="password" 
				name="password" 
				class="form-control" 
				placeholder="Enter your password"
				required
			/>
		</div>

		<button type="submit" id="signin-btn" class="btn btn-primary">Sign In</button>
	</form>

	<div class="login-footer">
		Don't have an account? <a href="{% url 'register' %}">Register here</a>
	</div>
</div>

<script>
document.getElementById('login-form').addEventListener('submit', loginUser);

async function loginUser(event) {
	event.preventDefault();
	event.stopPropagation();

	const signinBtn = document.getElementById('signin-btn');
	const emailVal = document.getElementById('email').value.trim();
	const passwordVal = document.getElementById('password').value;
	const errEl = document.getElementById('error-msg');

	// Clear error
	errEl.style.display = 'none';
	errEl.textContent = '';

	// Validation
	if (!emailVal || !passwordVal) {
		errEl.textContent = 'Please enter both email and password.';
		errEl.style.display = 'block';
		return;
	}

	signinBtn.disabled = true;
	signinBtn.textContent = 'Signing in...';

	const body = {
		username: emailVal,
		email: emailVal,
		password: passwordVal
	};

	try {
		// ✅ STEP 1: TOKEN LOGIN via Djoser
		const resp = await fetch('/api/auth/token/login/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'Accept': 'application/json'
			},
			body: JSON.stringify(body)
		});

		console.log('[Step 1] POST /api/auth/token/login/ status:', resp.status);

		let data = null;
		try { 
			data = await resp.json(); 
		} catch (e) {
			console.warn('Could not parse JSON:', e);
		}

		console.log('[Step 1] Response body:', data);

		// Extract token from response (Djoser returns auth_token)
		const token = data && (data.auth_token || data.token || data.access);

		if (resp.ok && token) {
			// ✅ STEP 2: SAVE TOKEN to localStorage
			localStorage.setItem('token', token);
			console.log('[Step 2] Saved token to localStorage:', token.substring(0, 10) + '...');

			// ✅ STEP 3: CREATE DJANGO SESSION USING TOKEN
			const sessionResp = await fetch('/accounts/token-session-login/', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ token: token })
			});

			console.log('[Step 3] POST /accounts/token-session-login/ status:', sessionResp.status);
			const sessionData = await sessionResp.json().catch(() => ({}));
			console.log('[Step 3] Session response:', sessionData);

			if (sessionResp.ok) {
				// ✅ STEP 4: REDIRECT TO DASHBOARD
				console.log('[Step 4] Redirecting to dashboard...');
				window.location.replace('/accounts/dashboard/');
				return;
			} else {
				throw new Error('Session creation failed: ' + (sessionData.detail || 'Unknown error'));
			}
		}

		// ❌ ERROR HANDLING
		let msg = 'Login failed — check your credentials';
		if (data) {
			if (data.detail) msg = data.detail;
			else if (data.non_field_errors) msg = data.non_field_errors.join(' ');
			else {
				const vals = Object.values(data).flat().filter(v => typeof v === 'string');
				if (vals.length) msg = vals.join(' ');
			}
		} else if (resp.status === 401) {
			msg = 'Unauthorized — bad email or password';
		} else if (resp.status === 405) {
			msg = 'Method not allowed (POST endpoint issue)';
		}

		errEl.textContent = msg;
		errEl.style.display = 'block';
		console.warn('[Error] Login failed:', resp.status, data);

	} catch (err) {
		console.error('[Exception] Login error:', err);
		errEl.textContent = 'Network or server error — check console for details.';
		errEl.style.display = 'block';
	} finally {
		signinBtn.disabled = false;
		signinBtn.textContent = 'Sign In';
	}
}
</script>
{% endblock %}
